<!DOCTYPE html>
<html>
  <head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="shortcut icon" href="images/sc_logo.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css" integrity="sha512-wcw6ts8Anuw10Mzh9Ytw4pylW8+NAD4ch3lqm9lzAsTxg0GFeJgoAtxuCLREZSC5lUXdVyo/7yfsqFjQ4S+aKw==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet.js" integrity="sha512-mNqn2Wg7tSToJhvHcqfzLMU6J4mkOImSPTxVZAdo+lcPlk+GhZmYgACEe0x35K7YzW1zJ7XyJV/TT1MrdXvMcA==" crossorigin=""></script>

    <title>Inventory Details</title>

    <!-- Bootstrap core CSS -->
    <link href="./bootstrap3/css/bootstrap.css" rel="stylesheet">

    <!-- Custom styles for this template -->
		<link rel="stylesheet" href="./bootstrap3/css/navbar-fixed-top.css">
		<link rel="stylesheet" href="./css/main.css">
		<link rel="stylesheet" href="./leaflet/leaflet.css" />
		<link rel="stylesheet" href="./leaflet/MarkerCluster-sc.css" />
		<link rel="stylesheet" href="./css/jquery-ui.css">
			
    <!-- Just for debugging purposes. Don't actually copy this line! -->
    <!--[if lt IE 9]><script src="../../docs-assets/js/ie8-responsive-file-warning.js"></script><![endif]-->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
  <!-- Fixed navbar -->
  <div class="navbar navbar-default navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <div class="navbar-header">
	<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	  <span class="sr-only">Toggle navigation</span>
	  <span class="icon-bar"></span>
	  <span class="icon-bar"></span>
	  <span class="icon-bar"></span>
	</button>
	<a class="navbar-brand" href="?dest=index"><img src="images/sc_logo.png" class="img-circle logo" /> ShakeCast</a>
      </div>
      <div class="navbar-collapse collapse">
	<ul id="nav_menu" class="nav navbar-nav">
	  <li><a href="?dest=index">Home</a></li>
	  <li><a href="#about">About</a></li>
	  <li class="dropdown active">
	  <a href="?dest=list" class="dropdown-toggle" data-toggle="dropdown">Earthquake List <b class="caret"></b></a>
	  <ul class="dropdown-menu">
	    <li><a href="?dest=list">Recent Events</a></li>
	    <li class="divider"></li>
	    <li><a href="?dest=list&type=major">Significant Events</a></li>
	    <li><a href="?dest=list&type=scenario">Scenarios</a></li>
	    <li class="divider"></li>
	  </ul>
	  </li>
	    <li><a href="?dest=preference">Settings</a></li>
		<TMPL_VAR NAME=ADMIN>
		<TMPL_VAR NAME=LOGOUT>
	</ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>

<!-- Subhead
================================================== -->
<header class="header" id="overview">
  <div class="container">
    <h2>Inventory Details <small>Exposed facility list and detailed information on assessed fragility</small></h2>
    <ol class="breadcrumb">
      <li class="pull-right"><a href="#" id="aebm_link">AEBM View</a><a href="#" id="tab_link">Table View</a></li>
      <li><a href="?dest=index">Home</a></li>
      <li><a href="?dest=list">Earthquakes</a></li>
      <li id="evid"><a href="#">Event</a></li>
      <li class="active"></li>
    </ol>
  </div>
</header>


<div class="container">

      <div class="row">
        <div class="col-md-3">
	  <!-- Single button
	  <div class="btn-group">
	    <button type="button" class="btn btn-sm btn-default dropdown-toggle" data-toggle="dropdown">
	      Earthquake Product <span class="caret"></span>
	    </button>
	    <ul class="dropdown-menu" role="menu" id="sidebar_prod">
	    </ul>
	  </div>
	   -->
	   
          <div class="panel panel-default">
	    <div class="panel-heading">Inventory Type</div>
	    <div class="list-group" id="sidebar">
	    </div>
          </div><!--/.well -->
	  
          <div class="panel panel-default">
	    <div class="panel-heading">High Priority Facilities</div>
	    <div class="list-group" id="sidebar_fac">
	    </div>
          </div><!--/.well -->
	  
          <div class="panel panel-default">
	    <div class="panel-heading">Earthquake Product</div>
	    <div id="sidebar_prod">
	    </div>
          </div><!--/.well -->
	  
        </div><!--/span-->
	
        <div class="col-md-9">
            <!-- Main hero unit for a primary marketing message or call to action -->
            <div class="panel panel-default" id="main_pane">
				<div class="panel-heading" id="map_title"></div>
				<div id="map_canvas" style="width:800px; height:400px;"></div>
 				<div id="caption"></div>
           </div>

          <div class="panel panel-default" id="fac_shaking">
	    <div class="panel-heading"></div>
	    <div class="panel-body">
	    </div>
          </div><!--/.well -->
            <!-- Example row of columns
            <div class="row">
		<div class="accordion"></div>
            </div>
 -->

        </div> <!-- /container -->
      </div> <!-- /container -->

    <!-- Footer
    ================================================== -->
    <footer class="footer">
      <div class="container">
        <ul class="footer-links">
          <li><a href="http://earthquake.usgs.gov">&copy; USGS 2017</a></li>
          <li class="muted">&middot;</li>
          <!-- <li><a href="?dest=index">Desktop</a></li>
          <!-- <li class="muted">&middot;</li> -->
          <!-- <li><a href="?dest=mobile">Mobile</a></li> -->
					<li>Rev. 		<TMPL_VAR NAME=SOFTWARE_REVISION></li>
        </ul>
     </div>
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <script type="text/javascript" src="./js/jquery.min.js"></script>
    <script type="text/javascript" src="./bootstrap3/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="./js/jquery-ui.js"></script>
    <script type="text/javascript" src="./js/main.js"></script>
    <script type="text/javascript" src="./js/loadXML.js"></script>
    <script type="text/javascript" src="./js/sc_constant.js"></script>
    <script type="text/javascript" src="./js/storage.js"></script>
    <script type="text/javascript" src="./leaflet/leaflet.markercluster-sc.js"></script>
 
    <script>
			var map = L.map('map_canvas').setView([40, -100], 4);
      var sc_id = gup('event');
      var type = gup('type') ? gup('type') : 'actual';
      var age = gup('age') ? gup('age') : 'week';
      var fac_des = [];
      var fac_info = [];
	  	var fac_type;
      var start=0, length=0, total;
      var sm_url = 'scripts/r/damage/datatables';
      var marker_icon = [];
			var markers = [];
			var markers_index = [];
			var markerCluster;	

	    SC_DEF.init();
        //var sm_url = 'scripts/shakemap.pl/from_id/' + sc_id;
        var username = SC_DEF.user ? SC_DEF.user : 'guest';
        var password = SC_DEF.pass ? SC_DEF.pass : 'guest';
        var sm_url = 'scripts/r/user/from_id/'+username;
        var submit_data = {
        };

			var epicenterIcon = L.icon({
				iconUrl: './images/epicenter.png',
				iconSize: [25, 25],
				iconAnchor: [12, 12],
				popupAnchor: [0, -28]
			});

      $(window).load(function() {
				$("#fac_shaking").hide();
				$("#sidebar_fac").hide();
				$("#sidebar").hide();
				
				L.tileLayer(<TMPL_VAR NAME=MAP_PROVIDER>).addTo(map);
				L.control.scale({maxWidth: 150}).addTo(map);

				if (!(type)) {
					type = SC_DEF.event_type ? SC_DEF.event_type : 'actual';
				}
				if (!(age)) {
					age = SC_DEF.recent_events ? parseInt(SC_DEF.recent_events) : 'week';
				}

				if (sc_id)  {
					$(".breadcrumb #evid").html('<a href="#">'+sc_id+'</a>');
					$(".breadcrumb #tab_link").html('<a class="btn btn-default" role="button" href="?dest=event_tab&event='+sc_id+'">Table View</a>');
					$(".breadcrumb #aebm_link").html('<a class="btn btn-default" role="button" href="?dest=event_aebm&event='+sc_id+'">AEBM View</a>');
				}
	
				load_sm();
				load_fac();
				load_prod();
      }).trigger('resize');

			$(window).resize(function() {
				//oTable.fnAdjustColumnSizing();
				//$("#eq_content_table").width($(".row").width());
				$("#map_canvas").width($("#main_pane").width());
				$("#map_canvas").height(($("#map_canvas").width())/2);
				//console.log($("#map_canvas").width());
				//google.maps.event.trigger(map, 'resize');
				$("#sidebar_fac").height($("#map_canvas").height()/2);
				$("#sidebar_prod").height($("#map_canvas").height()/2);
				var cont_height = $("#map_canvas").height() + $(".accordion").height();
				$('html').css('height', cont_height);
			});

	function makeGraph()
	{
		var dnl = $(".histogram").each(function() {
			var component = $(this).find("li").each( function(index) {
			var item = $(this).text();
			var color = this.style.background=color;
			var content = item.split(":");
			var value = content[0];
			if (content[1] != 'GREY') {
			this.style.height=value/2 + "px";
			this.style.top=(70 - value/2) + "px";
			this.style.left = ((index-1) * 35 + 5) + "px";
			this.innerHTML = value + "%";
			this.style.visibility="visible";
			color = content[2];
			if(color != false) this.style.background=color;
			} else {
			this.style.height="1px";
			this.style.top="45px";
			this.style.left = "0px";
			this.style.width = "180px";
			this.style.textAlign = "right";
			this.innerHTML = "50%";
			this.background = "white";
			this.borderStyle = "dotted";
			$(this).css('moz-box-shadow', '');
			$(this).css('webkit-box-shadow', '');
			$(this).css('box-shadow', '');
			this.style.visibility="visible";
			color = content[2];
			if(color != false) this.style.background=color;
			}
			/*labels.innerHTML = labels.innerHTML +
				 "<span style='margin:8px;background:"+ color+"'>" +
				 content[1] + "</span>";*/
		});
		});
	}

	function load_prod ( )
	{
	  //var sm_url = 'scripts/product.pl/from_id/'+ sc_id;
	  var sm_url = 'scripts/r/product/from_id/'+ sc_id;
	  var html_array = [];

	  $.post(sm_url, submit_data, function(data) {

	    // Are there even any EQ to display?
	    if (data.product.length <= 0) {
		    return;
	    }

	    var products = data.product;
	    for (var i=0; i < products.length; i++) {
	    //MAPAPP.addMarker(data.facility_damage[key]);
	    var product = products[i];
	    //if (!product_type[product.product_type]) {continue;}
	    var file_path;
	    var img_path;
	    if (product.display) {
	      if (product.eq_product) {
		file_path = 'data/' + product.filename;
	      } else {
		file_path = 'data/' + sc_id + '/' + product.filename;
	      }
	    if (product.url) {
		    img_path = product.url;
	    } else {
		    img_path = file_path;
	    }
	      html_array = html_array.concat([
	      '<a class="list-group-item" href="' + file_path + '">',
	      '<img src="' + img_path + '" class="img-thumbnail" style="max-width:32px"> ',
		product.name + '</a>',
	      ]);
	    }}
	    var event_id = sc_id.replace(/-.*$/,"");
	      html_array = html_array.concat([
	      '<a class="list-group-item" href="http://earthquakes.usgs.gov/earthquakes/eventpage/',
	      event_id + '">',
		'<img src="images/usgs_green.png" class="img-thumbnail" style="max-width:32px"> ',
		'USGS Event Page</a>',
	      ]);

	    $("#sidebar_prod").append(html_array.join(''));
	  }, 'json');
	}

    function load_fac(){
			//sm_url = 'scripts/shaking.pl/shaking_summary/' + sc_id;
			sm_url = 'scripts/r/shaking/shaking_summary/' + sc_id;
			$.post(sm_url, submit_data, function(data) {

				// Are there even any EQ to display?
				if (data.length <= 0) {
					return;
				}
				var total_count = 0;
				for (var i=0; i < data.length; i++) {
				total_count += parseInt(data[i].count);
				}
				data.push({facility_type: 'ALL', count:total_count});

				var base_url = window.location.pathname + '?event=' + sc_id;
				for (var i=0; i < data.length; i++) {
					var event = data[i];
					$("#sidebar").append('<a class="facility_type list-group-item" id="' + event.facility_type +
						'" href="#"><img src="images/' + event.facility_type + '.png"> ' + event.facility_type +
						' (' + event.count + ')</a>');
					marker_icon[event.facility_type] =
						{
							iconUrl: 'images/' + event.facility_type + '.png',
							iconSize: [25, 25],
							iconAnchor: [12, 12],
							popupAnchor: [0, -28]
						};
				}
				$("#sidebar").show();

				$('#sidebar a').on('click', function() {
					$('.facility_type').removeClass("active");
					if (this.id != type) {
						//MAPAPP.removeMarkers();
						start = 0;
					}
					type = this.id;
					$('#'+ type).addClass("active");
					if (type != fac_type) {
						fac_type = type;
						load_sibar_fac();
						load_marker();
					}
					});
			$('#sidebar a:first').trigger('click');

			}, 'json');
		}

      function load_sibar_fac(){
		//var local_url = 'scripts/damage.pl/datatables/' + sc_id + '?type=' + type + '&start=' + start + '&length=' + length;
		var local_url = 'scripts/r/damage/from_id/' + sc_id;
		var all = (SC_DEF.allmarker_flag) ? 1 : 0;
		$.post(local_url,  {type:type, start:start, length:length, all:all}
			, function(data) {

			// Are there even any EQ to display?
			if (typeof data.grid.shakemap_id === "undefined") {
				return;
			}

			$("#sidebar_fac").html('');
			var facility_probability = data.facility_probability;
			var html_array = [];
			var severity_index = [];
			if (data.severity_index) {
				severity_index = data.severity_index.slice(0);
			} else {
			for ( var key in data.facility_damage) severity_index.push(key);
			}
			for ( var sev_ind =0; sev_ind< severity_index.length; sev_ind++) {
			var fac_index = severity_index[sev_ind];
			//MAPAPP.addMarker(data.facility_damage[fac_index]);

			var facility = data.facility_damage[fac_index];
			$(".breadcrumb li").last().html(facility.facility_type + ' : ' + facility.facility_name);
			var icon_type =  facility.facility_type + facility.damage_level;
			icon_type = icon_type.toLowerCase();
			$("#sidebar_fac").append('<a class="facility_type list-group-item" id="' + facility.facility_id +
				'" href="#"><img src="images/' + icon_type + '.png"> ' + facility.facility_name + '</a>');
 			$('#sidebar_fac #'+facility.facility_id).on('click', function() {
			  //markers[markers_index[this.id]].fire('click');
			});
			}
			$("#sidebar_fac").show();


		}, 'json');
		}

		function load_sm(){
			//var sm_url = 'scripts/shakemap.pl/from_id/' + sc_id;
			var sm_url = 'scripts/r/shakemap/from_id/' + sc_id;
			$.post(sm_url, submit_data, function(data) {

			// Are there even any EQ to display?
			if (typeof data.shakemap_id === "undefined") {
				return;
			}

			var smMarker = L.marker([data.lat, data.lon], {
								icon: epicenterIcon
							}).addTo(map);


			var lat_min = parseFloat(data.lat_min);
			var lat_max = parseFloat(data.lat_max);
			var lon_min = parseFloat(data.lon_min);
			var lon_max = parseFloat(data.lon_max);

			var img = 'data/'+ sc_id +'/ii_overlay.png';
			var imageBounds = [[lat_min, lon_min], [lat_max, lon_max]];
			var overlay = L.imageOverlay(img, imageBounds, {'opacity': 0.6});
			overlay.addTo(map);
			map.fitBounds(imageBounds);

			}, 'json');
    }

    function addCaption(sm_id, facTypes) {
			//sm_id = facility.shakemap_id + '-' + facility.shakemap_version;
			//var dmg_url = 'scripts/damage.pl/from_id/'+sm_id+'?action=summary';
			var dmg_url = 'scripts/r/damage/from_id/'+sm_id;
			var dmg_submit = $.extend(submit_data,  {'action':'summary'});
			if (facTypes != "ALL") {
			  dmg_submit.type= facTypes;
			}
			$.post(dmg_url, dmg_submit, function(summary) {
				var damage_summary = '<div class="progress">';
				// Are there even any EQ to display?
				if (summary.count > 0) {
					jQuery.each(summary.damage_summary, function(i, val) {
						//damage_summary += '<div class="progress-bar ' + bar[i] + '" style="width: ' + val/summary.count*100 + '%;">' + val + '</div>';
						damage_summary += '<div class="progress-bar ' + bar[i] + '" style="width: 20%;">' + val + '</div>';
					});
				}
				damage_summary += '</div>';
				$("#caption").html(damage_summary);
			}, 'json');
    } // watchHash

    function loadInfo(facility_id) {
		var local_url = 'scripts/r/facility/from_id/'+facility_id;
		var infocontent = $.post(local_url, submit_data, function(data) {
			var html_array = [
				'<div  class="panel panel-success"><div class="panel-heading text-center"><h4>Facility Information</h4></div>',
				'<table class="table table-striped table-responsive">',
				'<tr><td><b>Facility ID</b></td><td>' + data.external_facility_id + ' (' + data.facility_type + ')</td></tr>',
				'<tr><td><b>Description</b></td><td>' + data.facility_name + '</td></tr>',
				(data.description) ? '<tr><td><b>Description</b></td><td>' + data.description + '</td></tr>' : '',
				'<tr><td><b>Latitude</b></td><td>' + data.lat_min + ' / ' + data.lat_max + '</td></tr>',
				'<tr><td><b>Logitude</b></td><td>' + data.lon_min + ' / ' + data.lon_max + '</td></tr>',
				'<tr><td><b>Last Updated</b></td><td>' + data.update_timestamp + '</td></t>',
				'</table></div>',
			];
			var infocontent = html_array.join('');
			if (data.feature.length) {
			if (data.feature[0].description) infocontent = data.feature[0].description;
			}
			return infocontent;
		}, 'json');
		console.log(infocontent);
		return infocontent;
    } // addMarker
    
		function load_marker(){
			addCaption(sc_id, fac_type);
			//var sm_url = 'scripts/shakemap.pl/from_id/' + sc_id;
			var sm_url = 'data/'+sc_id+'/fac_damage.json';
			var all = (SC_DEF.allmarker_flag) ? 1 : 0;
			$.getJSON(sm_url, function(data) {

				// Are there even any EQ to display?
				if (typeof data === "undefined") {
					return;
				}
		
								//Custom radius and icon create function
								var markers = L.markerClusterGroup({
									maxClusterRadius: 38,
									iconCreateFunction: function (cluster) {
										//var sizes = [26, 28, 33, 40, 50];
										var markers = cluster.getAllChildMarkers();
										var maxSeverity = 1;
										var c = 'marker-cluster-grey';
										for (var i=0; i < markers.length; i++) {
											if (markers[i].severity_rank > maxSeverity) {maxSeverity = markers[i].severity_rank;}
										}
										if (maxSeverity === 100) {
											c = 'marker-cluster-green';
										} else if (maxSeverity === 200) {
											c = 'marker-cluster-yellow';
										} else if (maxSeverity === 300) {
											c = 'marker-cluster-orange';
										} else if (maxSeverity === 400) {
											c = 'marker-cluster-red';
										}	
										return L.divIcon({ html: '<div><span>' + markers.length + '</span></div>', className: 'marker-cluster '+c, iconSize: new L.point(33,33) });
									},
									//Disable all of the defaults:
									spiderfyOnMaxZoom: false, showCoverageOnHover: false, zoomToBoundsOnClick: true
								});

								var index = 0;
								var marker_icon = [];

								for ( var key in data.facility_damage) {
									var facility = data.facility_damage[key];
									lat = parseFloat(facility.lat_min);
									lon = parseFloat(facility.lon_min);
									icon_type =  facility.facility_type + facility.damage_level;
									icon_type = icon_type.toLowerCase();
									var facility_severity = parseInt(facility.severity_rank);

									var myIcon = L.icon({
										iconUrl: "./images/" + icon_type + ".png",
										iconSize: [25, 24],
										iconAnchor: [12, 12],
										shadowUrl: "./images/shadow.png",
										shadowSize: [21, 14],
										//shadowAnchor: [12, 12]
									});

									var infocontent = loadInfo(facility.facility_id);

									var marker = L.marker([lat, lon], {icon: myIcon})
										.bindPopup(infocontent);
									marker.severity_rank = facility_severity;

									markers.addLayer(marker);

									if (typeof marker_icon[icon_type] === "undefined") {
									marker_icon[icon_type] =
										{
										url: './images/' + icon_type + '.png',
										facility_type: facility.facility_type,
										facility_count: 1,
										};
									} else {
										marker_icon[icon_type].facility_count += 1;
									}


								};
								map.addLayer(markers);
								
								var disp_icon = [];
								for (var key in marker_icon) disp_icon.push(marker_icon[key]);
								disp_icon.sort(function(a, b){
									var a1= a.severity_rank, b1= b.severity_rank;
									if(a1== b1) return 0;
									return a1> b1? 1: -1;
								});
								var info = L.control({position: 'bottomright'});

								info.onAdd = function (map) {
									this._div = L.DomUtil.create('div', 'info legend'),
									this.update();
									return this._div;
								};

								// method that we will use to update the control based on feature properties passed
								info.update = function (disp_icon) {
									this._div.innerHTML = '<img src="./images/cluster/m1_1.png" /><img src="./images/cluster/m1_100.png" /><img src="./images/cluster/m1_200.png" /><img src="./images/cluster/m1_300.png" /><img src="./images/cluster/m1_400.png" />' + 
											'<br />Facility Cluster<br/><img src="./images/epicenter.png" /> Earthquake Epicenter<br />';

									for (var key in disp_icon) {
										this._div.innerHTML += 
											'<img src="' + disp_icon[key].url + '" /> ' +
											disp_icon[key].facility_type + ' : ' +
											disp_icon[key].facility_count + '<br />';
									}
								};

								info.addTo(map);

		});
      }

    </script>

  </body>
</html>
