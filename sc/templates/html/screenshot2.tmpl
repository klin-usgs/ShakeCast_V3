<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
    <link href="./bootstrap3/css/bootstrap.css" rel="stylesheet">

    <!-- Custom styles for this template -->
	<link rel="stylesheet" href="./css/main.css">
	<link rel="stylesheet" href="./css/jquery-ui.css">

    <script type="text/javascript">
      var prefix;
      var script = '<script type="text/javascript" src="';
      var loc = new String(window.parent.document.location);
      if (loc.indexOf("https://")!= -1)
	prefix = "https://";
      else
	prefix = "http://";
      script += prefix + 'maps.google.com/maps/api/js?sensor=false"><' + '/script>';
      document.write(script);
    </script>
    <script type="text/javascript" src="./js/jquery.min.js"></script>
    <script type="text/javascript" src="./bootstrap3/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="./js/main.js"></script>
    <script type="text/javascript" src="./js/shakemap.js"></script>
    <script type="text/javascript" src="./js/loadXML.js"></script>
    <script type="text/javascript" src="./js/mapapp_capture.js"></script>
    <script type="text/javascript" src="./js/sc_constant.js"></script>
    <script type="text/javascript" src="./js/storage.js"></script>
    <script type="text/javascript" src="./js/sc_markerclusterer.js"></script>
<script type="text/javascript">
var evid;
var type
//var mmi = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X+"];
//var zoom = [8, 8, 8, 7, 7, 7, 6, 6, 6, 6, 6, 5, 5, 5, 5];
var facMarkers = [];
//var bar = {'GREY':'bar-grey', 'GREEN':'bar-success', 'YELLOW':'bar-yellow', 'ORANGE':'bar-warning', 'RED':'bar-danger'};
		var map;
		var markers = [];
		var markerCluster;
	        var marker_icon = [];

function initialize() {
	sc_id = evid ? evid : gup('event');
	type = gup('type');

	var local_url = 'scripts/r/shakemap/from_id/' + sc_id;
	if (type) {
		local_url += '?type='+type;
	}
	$.getJSON(local_url, function(data) {

	  // Are there even any EQ to display?
	  if (typeof data.shakemap_id === "undefined") {
		return;
	  }

		var lat_min = parseFloat(data.lat_min);
		var lat_max = parseFloat(data.lat_max);
		var lon_min = parseFloat(data.lon_min);
		var lon_max = parseFloat(data.lon_max);

		var rectBounds = new google.maps.LatLngBounds(
					new google.maps.LatLng(lat_min, lon_min),
					new google.maps.LatLng(lat_max, lon_max));
		var img = 'data/'+ sc_id +'/ii_overlay.png';
		var latlng = new google.maps.LatLng((lat_min+lat_max)/2, (lon_min+lon_max)/2);

		map = MAPAPP.init(latlng, zoom[parseInt(lat_max-lat_min+0.5)]);
		console.log(zoom[parseInt(lat_max-lat_min+0.5)]+' '+parseInt(lat_max-lat_min+0.5));

		MAPAPP.loadSM(rectBounds, img);

		var event = data;
		event.facility_type = "epicenter";
		MAPAPP.addMarker(event);
		
			
		load_marker(map, sc_id);
	});

	var dmg_url = 'scripts/r/damage/from_id/'+sc_id+'?action=summary';
	$.getJSON(dmg_url, function(summary) {
		var damage_summary = '<div class="progress">';
		// Are there even any EQ to display?
		if (summary.count > 0) {
			jQuery.each(summary.damage_summary, function(i, val) {
				damage_summary += '<div class="progress-bar ' + bar[i] + '" style="width:20%;">' + val + '</div>';
			});
		}
		damage_summary += '</div>';
		$("#caption").html(damage_summary);
	});
   // update the map display

		$('html').width($("map_pane").width());
		$('html').height($("map_pane").height());
} // initializek

      function load_marker(map, sc_id){
		//var sm_url = 'scripts/shakemap.pl/from_id/' + sc_id;
		var sm_url = 'scripts/r/damage/marker/' + sc_id;
		var all = (SC_DEF.allmarker_flag) ? 1 : 0;
		$.post(sm_url, {all : all}, function(data) {

		// Are there even any EQ to display?
		if (typeof data === "undefined") {
			return;
		}

		for (var icon_type in marker_icon) {
		    marker_icon[icon_type].facility_count = 0;
		} // for
		for (var fac in data) {
		  var facility = data[fac];
		  var latLng = new google.maps.LatLng(facility.latitude,
		      facility.longitude);
		  var icon_type =  facility.facility_type + facility.damage_level;
		  icon_type = icon_type.toLowerCase();
		  if (typeof marker_icon[icon_type] === "undefined") {
		      marker_icon[icon_type] =
			{
			  url: 'images/' + icon_type + '.png',
			  // This marker is 20 pixels wide by 32 pixels tall.
			  size: new google.maps.Size(25, 25),
			  // The origin for this image is 0,0.
			  origin: new google.maps.Point(0,0),
			  // The anchor for this image is the base of the flagpole at 0,32.
			  anchor: new google.maps.Point(12, 12),
			  facility_type: facility.facility_type,
			  facility_count: 1,
			};
		  } else {
		    marker_icon[icon_type].facility_count += 1;
		  }
		  var marker = new google.maps.Marker({
		    position: latLng,
		    //shadow: markershadow,
		    icon: marker_icon[icon_type],
		    facility_id: fac,
		    facility_type: facility.facility_type,
		    severity_rank: facility.severity_rank,
		    facility_name: facility.facility_name,
		  });
		  
		  markers.push(marker);
		}
		markerCluster = new MarkerClusterer(map, markers);
		
		var disp_icon = [];
		for (var key in marker_icon) disp_icon.push(marker_icon[key]);
		disp_icon.sort(function(a, b){
		    var a1= a.severity_rank, b1= b.severity_rank;
		    if(a1== b1) return 0;
		    return a1> b1? 1: -1;
		});
		
		MAPAPP.addLegend(disp_icon);
		
		}, 'json');
      }

</script>
</head>
<body onload="initialize()">
<div id="map_pane" style="width:1024px; height:512px">
<div id="map_canvas" style="width:1024px; height:512px"></div>
<div id="caption"></div>
</div>
</body></html>
